<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Caro vs AI</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background: #eee;
    }
    h1 { margin: 20px 0 10px; }
    #board {
      display: grid;
      grid-template-columns: repeat(20, 30px);
      grid-template-rows: repeat(20, 30px);
      gap: 1px;
      margin: 20px auto;
      width: fit-content;
      background: #444;
    }
    .cell {
      width: 30px;
      height: 30px;
      background: #fff;
      font-size: 20px;
      line-height: 30px;
      text-align: center;
      cursor: pointer;
    }
    #status {
      font-size: 18px;
      margin-top: 10px;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
    }
  </style>
</head>
<body>

<h1>Caro - Bạn vs AI</h1>
<div id="board"></div>
<div id="status">Lượt của bạn (X)</div>
<button onclick="resetGame()">Chơi lại</button>

<script>
  const size = 20;
  const board = document.getElementById("board");
  const status = document.getElementById("status");
  let cells = [], player = 'X', ai = 'O', gameOver = false;

  function createBoard() {
    board.innerHTML = '';
    cells = Array.from({ length: size }, () => Array(size).fill(''));
    for (let r = 0; r < size; r++) {
      for (let c = 0; c < size; c++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.row = r;
        cell.dataset.col = c;
        cell.addEventListener("click", handleClick);
        board.appendChild(cell);
      }
    }
  }

  function handleClick(e) {
    if (gameOver) return;
    const r = +e.target.dataset.row;
    const c = +e.target.dataset.col;
    if (cells[r][c]) return;
    move(r, c, player);
    if (checkWin(r, c, player)) return endGame("Bạn thắng!");
    setTimeout(aiMove, 100);
  }

  function move(r, c, char) {
    cells[r][c] = char;
    const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
    cell.textContent = char;
  }

  function aiMove() {
    if (gameOver) return;
    let best = { score: -Infinity, row: -1, col: -1 };
    for (let r = 0; r < size; r++) {
      for (let c = 0; c < size; c++) {
        if (cells[r][c] === '') {
          const score = evaluateMove(r, c, ai) + evaluateMove(r, c, player) * 0.8;
          if (score > best.score) best = { score, row: r, col: c };
        }
      }
    }
    move(best.row, best.col, ai);
    if (checkWin(best.row, best.col, ai)) return endGame("AI thắng!");
  }

  function evaluateMove(r, c, char) {
    let score = 0;
    const dirs = [
      [[0,1], [0,-1]], [[1,0], [-1,0]],
      [[1,1], [-1,-1]], [[1,-1], [-1,1]]
    ];
    for (let [d1, d2] of dirs) {
      let count = 1;
      count += countDirection(r, c, d1[0], d1[1], char);
      count += countDirection(r, c, d2[0], d2[1], char);
      if (count >= 5) return 100000;
      score += Math.pow(count, 3);
    }
    return score;
  }

  function countDirection(r, c, dr, dc, char) {
    let count = 0;
    for (let i = 1; i < 5; i++) {
      const nr = r + dr * i, nc = c + dc * i;
      if (nr < 0 || nr >= size || nc < 0 || nc >= size || cells[nr][nc] !== char) break;
      count++;
    }
    return count;
  }

  function checkWin(r, c, char) {
    const dirs = [
      [[0,1], [0,-1]], [[1,0], [-1,0]],
      [[1,1], [-1,-1]], [[1,-1], [-1,1]]
    ];
    for (let [d1, d2] of dirs) {
      let count = 1;
      count += countDirection(r, c, d1[0], d1[1], char);
      count += countDirection(r, c, d2[0], d2[1], char);
      if (count >= 5) return true;
    }
    return false;
  }

  function endGame(msg) {
    status.textContent = msg;
    gameOver = true;
  }

  function resetGame() {
    createBoard();
    status.textContent = "Lượt của bạn (X)";
    gameOver = false;
  }

  createBoard();
</script>
</body>
</html>
