<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Firefly</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at 50% 30%, #001a33, #000000);
      font-family: sans-serif;
      color: #fff;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: transparent;
    }
    #scoreboard {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
    }
    #startBtn, #restartBtn {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      padding: 10px 20px;
      background: #222;
      color: white;
      border: none;
      cursor: pointer;
    }
    #startBtn { top: 50%; }
    #restartBtn { top: 60%; display: none; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="480" height="640"></canvas>
<div id="scoreboard">Điểm: 0</div>
<button id="startBtn">Bắt đầu</button>
<button id="restartBtn">Chơi lại</button>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let firefly, pipes, score, isGameOver, gameSpeed;
let started = false, lastPipeTime = 0;

function resetGame() {
  firefly = { x: 80, y: 200, vy: 0, size: 30 };
  pipes = [];
  score = 0;
  isGameOver = false;
  gameSpeed = 2;
  lastPipeTime = Date.now();
  document.getElementById("scoreboard").innerText = `Điểm: ${score}`;
}

function drawFirefly() {
  const time = Date.now() / 200;
  const glow = Math.sin(time * 3) * 10 + 30;
  const gradient = ctx.createRadialGradient(firefly.x, firefly.y, 0, firefly.x, firefly.y, glow);
  gradient.addColorStop(0, "rgba(255,255,150,0.8)");
  gradient.addColorStop(1, "rgba(255,255,150,0)");
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.arc(firefly.x, firefly.y, glow, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#FFD700";
  ctx.beginPath();
  ctx.arc(firefly.x, firefly.y, firefly.size / 2, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#fff";
  ctx.beginPath();
  ctx.arc(firefly.x - 10, firefly.y, 6, 0, Math.PI * 2);
  ctx.arc(firefly.x + 10, firefly.y, 6, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(firefly.x - 10, firefly.y, 2, 0, Math.PI * 2);
  ctx.arc(firefly.x + 10, firefly.y, 2, 0, Math.PI * 2);
  ctx.fill();
}

function drawPipes() {
  pipes.forEach(p => {
    ctx.fillStyle = "#44FF99";
    ctx.fillRect(p.x, 0, p.width, p.top);
    ctx.fillRect(p.x, canvas.height - p.bottom, p.width, p.bottom);
  });
}

function update() {
  if (!started || isGameOver) return;
  firefly.vy += 0.4;
  firefly.y += firefly.vy;
  pipes.forEach(p => p.x -= gameSpeed);

  if (Date.now() - lastPipeTime > 1500) {
    let gap = 120;
    let top = Math.random() * (canvas.height - gap - 100) + 20;
    pipes.push({ x: canvas.width, width: 50, top: top, bottom: canvas.height - top - gap });
    lastPipeTime = Date.now();
  }

  pipes = pipes.filter(p => p.x + p.width > 0);

  pipes.forEach(p => {
    if (firefly.x + firefly.size/2 > p.x &&
        firefly.x - firefly.size/2 < p.x + p.width &&
        (firefly.y - firefly.size/2 < p.top || firefly.y + firefly.size/2 > canvas.height - p.bottom)) {
      gameOver();
    } else if (p.x + p.width === firefly.x) {
      score++;
      if (score % 5 === 0) gameSpeed += 0.2;
      document.getElementById("scoreboard").innerText = `Điểm: ${score}`;
    }
  });

  if (firefly.y > canvas.height || firefly.y < 0) gameOver();
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawPipes();
  drawFirefly();
}

function loop() {
  update();
  render();
  requestAnimationFrame(loop);
}

function gameOver() {
  isGameOver = true;
  document.getElementById("restartBtn").style.display = "block";
}

function jump() {
  if (!started || isGameOver) return;
  firefly.vy = -6;
}

document.addEventListener("keydown", e => { if (e.code === "Space") jump(); });
canvas.addEventListener("click", jump);

document.getElementById("startBtn").onclick = () => {
  started = true;
  document.getElementById("startBtn").style.display = "none";
  resetGame();
};

document.getElementById("restartBtn").onclick = () => {
  resetGame();
  document.getElementById("restartBtn").style.display = "none";
};

resetGame();
loop();
</script>
</body>
</html>
