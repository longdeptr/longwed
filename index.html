<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Flappy Firefly</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at 50% 30%, #001a33, #000000);
      font-family: sans-serif;
      color: #fff;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: transparent;
    }
    #scoreboard {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
    }
    #startBtn, #restartBtn, #rankingBtn {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      padding: 10px 20px;
      background: #222;
      color: white;
      border: none;
      cursor: pointer;
    }
    #startBtn { top: 50%; }
    #restartBtn { top: 60%; display: none; }
    #rankingBtn {
      top: 10px;
      right: 10px;
      left: auto;
      font-size: 12px;
      padding: 4px 8px;
    }
    #rankingBoard {
      position: absolute;
      right: 10px;
      top: 40px;
      background: rgba(0,0,0,0.8);
      padding: 8px;
      font-size: 12px;
      display: none;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="480" height="640"></canvas>
<div id="scoreboard"></div>
<button id="startBtn">Bắt đầu</button>
<button id="restartBtn">Chơi lại</button>
<button id="rankingBtn">BXH</button>
<div id="rankingBoard">Đang tải BXH...</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC5JeYI5DKcmF3ZTIOiTH23dmDzfA_NVDs",
  authDomain: "flappy-firefly-bxh.firebaseapp.com",
  databaseURL: "https://flappy-firefly-bxh-default-rtdb.firebaseio.com",
  projectId: "flappy-firefly-bxh",
  storageBucket: "flappy-firefly-bxh.appspot.com",
  messagingSenderId: "469933896947",
  appId: "1:469933896947:web:46fdb11940b8b1a2f9cf65"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let firefly, pipes, birds, score, isGameOver, gameSpeed;
let playerName = prompt("Tên bạn:") || "Ẩn danh";
let started = false, lastPipeTime = 0, lastBirdTime = 0;

function resetGame() {
  firefly = { x: 80, y: 200, vy: 0, size: 30 };
  pipes = []; birds = [];
  score = 0; isGameOver = false;
  gameSpeed = 2;
  lastPipeTime = Date.now();
  lastBirdTime = Date.now();
}

function drawFirefly() {
  const time = Date.now() / 200;
  const glow = Math.sin(time * 3) * 10 + 30;
  const gradient = ctx.createRadialGradient(firefly.x, firefly.y, 0, firefly.x, firefly.y, glow);
  gradient.addColorStop(0, "rgba(255,255,150,0.8)");
  gradient.addColorStop(1, "rgba(255,255,150,0)");
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.arc(firefly.x, firefly.y, glow, 0, Math.PI * 2);
  ctx.fill();

  ctx.save();
  ctx.translate(firefly.x, firefly.y);
  const wingAngle = Math.sin(time * 10) * 0.5;
  ctx.rotate(wingAngle);
  ctx.fillStyle = "rgba(200,200,255,0.6)";
  ctx.beginPath();
  ctx.ellipse(0, -15, 8, 20, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.rotate(-2 * wingAngle);
  ctx.beginPath();
  ctx.ellipse(0, -15, 8, 20, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  ctx.fillStyle = "#FFD700";
  ctx.beginPath();
  ctx.arc(firefly.x, firefly.y, firefly.size / 2, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#fff";
  ctx.beginPath();
  ctx.arc(firefly.x - 10, firefly.y, 6, 0, Math.PI * 2);
  ctx.arc(firefly.x + 10, firefly.y, 6, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(firefly.x - 10, firefly.y, 2, 0, Math.PI * 2);
  ctx.arc(firefly.x + 10, firefly.y, 2, 0, Math.PI * 2);
  ctx.fill();
}

function drawPipes() {
  pipes.forEach(p => {
    const radius = 15;
    ctx.fillStyle = "#44FF99";
    ctx.lineJoin = "round";
    ctx.beginPath();
    ctx.moveTo(p.x, 0);
    ctx.lineTo(p.x + p.width, 0);
    ctx.lineTo(p.x + p.width, p.top);
    ctx.lineTo(p.x, p.top);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle = "#228855";
    ctx.lineWidth = 3;
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(p.x, canvas.height);
    ctx.lineTo(p.x + p.width, canvas.height);
    ctx.lineTo(p.x + p.width, canvas.height - p.bottom);
    ctx.lineTo(p.x, canvas.height - p.bottom);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  });
}

function drawBirds() {
  birds.forEach(b => {
    ctx.fillStyle = "#FF4444";
    ctx.beginPath();
    ctx.arc(b.x, b.y, 10, 0, Math.PI * 2);
    ctx.fill();
  });
}

function update() {
  if (!started || isGameOver) return;
  firefly.vy += 0.4;
  firefly.y += firefly.vy;
  pipes.forEach(p => p.x -= gameSpeed);
  birds.forEach(b => b.x -= gameSpeed + 1);

  if (Date.now() - lastPipeTime > 1500) {
    let gap = 120;
    let top = Math.random() * (canvas.height - gap - 100) + 20;
    pipes.push({ x: canvas.width, width: 50, top: top, bottom: canvas.height - top - gap });
    lastPipeTime = Date.now();
  }

  if (score >= 40 && Date.now() - lastBirdTime > 3000) {
    birds.push({ x: canvas.width, y: Math.random() * canvas.height });
    lastBirdTime = Date.now();
  }

  pipes = pipes.filter(p => p.x + p.width > 0);
  birds = birds.filter(b => b.x > -20);

  pipes.forEach(p => {
    if (firefly.x + firefly.size/2 > p.x &&
        firefly.x - firefly.size/2 < p.x + p.width &&
        (firefly.y - firefly.size/2 < p.top || firefly.y + firefly.size/2 > canvas.height - p.bottom)) {
      gameOver();
    } else if (p.x + p.width === firefly.x) {
      score++;
      if (score % 5 === 0) gameSpeed += 0.2;
    }
  });

  birds.forEach(b => {
    if (Math.hypot(b.x - firefly.x, b.y - firefly.y) < firefly.size/2 + 10) gameOver();
  });

  if (firefly.y > canvas.height || firefly.y < 0) gameOver();
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawPipes();
  drawBirds();
  drawFirefly();
  document.getElementById("scoreboard").innerText = `Điểm: ${score}`;
}

function loop() {
  update();
  render();
  requestAnimationFrame(loop);
}

function gameOver() {
  isGameOver = true;
  document.getElementById("restartBtn").style.display = "block";
  saveScore();
}

function jump() {
  if (!started || isGameOver) return;
  firefly.vy = -6;
}

document.addEventListener("keydown", e => { if (e.code === "Space") jump(); });
canvas.addEventListener("click", jump);

document.getElementById("startBtn").onclick = () => {
  started = true;
  document.getElementById("startBtn").style.display = "none";
  resetGame();
};

document.getElementById("restartBtn").onclick = () => {
  resetGame();
  document.getElementById("restartBtn").style.display = "none";
};

document.getElementById("rankingBtn").onclick = () => {
  const box = document.getElementById("rankingBoard");
  box.style.display = box.style.display === "none" ? "block" : "none";
  if (box.style.display === "block") loadRanking();
};

function saveScore() {
  db.ref("ranking").push({ name: playerName, score: score, time: new Date().toLocaleTimeString() });
}

function loadRanking() {
  const box = document.getElementById("rankingBoard");
  db.ref("ranking").orderByChild("score").limitToLast(5).once("value", snap => {
    let arr = [];
    snap.forEach(child => arr.push(child.val()));
    arr = arr.reverse();
    box.innerHTML = "BXH Online:<br>" + arr.map((e, i) => `${i+1}. ${e.name}: ${e.score} (${e.time})`).join("<br>");
  });
}

resetGame();
loop();
</script>
</body>
</html>
