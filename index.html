<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flappy Đom Đóm</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      overflow: hidden;
      background: linear-gradient(to bottom, #000428, #004e92);
      font-family: sans-serif;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #firefly {
      position: absolute;
      width: 30px;
      height: 30px;
      top: 40%;
      left: 50px;
      border-radius: 50%;
      background: yellow;
      box-shadow: 0 0 10px 4px rgba(255,255,100,0.9);
      transition: top 0.1s;
    }

    #firefly.flap::before, #firefly.flap::after {
      animation: flapWing 0.2s ease;
    }

    #firefly::before, #firefly::after {
      content: '';
      position: absolute;
      width: 15px;
      height: 15px;
      background: rgba(200, 200, 255, 0.6);
      border-radius: 50%;
      top: 2px;
    }

    #firefly::before { left: -10px; transform: rotate(-20deg); }
    #firefly::after { right: -10px; transform: rotate(20deg); }

    @keyframes flapWing {
      0% { transform: scale(1) rotate(20deg); }
      50% { transform: scale(0.8) rotate(0deg); }
      100% { transform: scale(1) rotate(20deg); }
    }

    .pipe {
      position: absolute;
      width: 60px;
      background: linear-gradient(to bottom, green, darkgreen);
    }

    #score {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      font-size: 32px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px black;
    }

    #startBtn, #restartBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 14px 24px;
      font-size: 20px;
      background: orange;
      color: white;
      border: none;
      border-radius: 10px;
      display: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="score">Điểm: 0</div>
    <div id="firefly"></div>
    <button id="startBtn">Bắt đầu</button>
    <button id="restartBtn">Chơi lại</button>
    <audio id="bgMusic" loop>
      <source src="thienlyba.mp3" type="audio/mpeg" />
    </audio>
  </div>

  <script>
    const game = document.getElementById("game");
    const firefly = document.getElementById("firefly");
    const scoreEl = document.getElementById("score");
    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");
    const bgMusic = document.getElementById("bgMusic");

    let fireflyY = game.clientHeight / 2;
    let velocity = 0;
    let gravity = 0.2;
    let jump = -5;
    let isPlaying = false;
    let pipes = [];
    let score = 0;
    let gameInterval, pipeInterval;

    function resetGame() {
      pipes.forEach(p => p.remove());
      pipes = [];
      fireflyY = game.clientHeight / 2;
      velocity = 0;
      firefly.style.top = fireflyY + "px";
      score = 0;
      scoreEl.textContent = "Điểm: 0";
    }

    function startGame() {
      resetGame();
      isPlaying = true;
      startBtn.style.display = "none";
      restartBtn.style.display = "none";
      bgMusic.play();

      gameInterval = setInterval(() => {
        velocity += gravity;
        fireflyY += velocity;
        firefly.style.top = fireflyY + "px";

        if (fireflyY > game.clientHeight - 30 || fireflyY < 0) endGame();

        pipes.forEach(pipe => {
          pipe.style.left = (parseInt(pipe.style.left) - 3) + "px"; // tốc độ nhanh hơn

          const pipeLeft = parseInt(pipe.style.left);
          const pipeTop = parseInt(pipe.style.top);
          const pipeHeight = parseInt(pipe.style.height);
          const fireflyTop = fireflyY;
          const fireflyBottom = fireflyY + 30;

          if (
            pipeLeft < 90 && pipeLeft + 60 > 50 &&
            (
              (pipe.classList.contains("top") && fireflyTop < pipeHeight) ||
              (!pipe.classList.contains("top") && fireflyBottom > pipeTop)
            )
          ) {
            endGame();
          }

          if (pipeLeft === 48 && pipe.classList.contains("top")) {
            score++;
            scoreEl.textContent = "Điểm: " + score;
          }
        });

        pipes = pipes.filter(pipe => parseInt(pipe.style.left) > -60);
      }, 20);

      pipeInterval = setInterval(() => {
        const gap = 140;
        const topHeight = Math.floor(Math.random() * 250) + 50;
        const bottomTop = topHeight + gap;

        const topPipe = document.createElement("div");
        topPipe.classList.add("pipe", "top");
        topPipe.style.height = topHeight + "px";
        topPipe.style.top = "0px";
        topPipe.style.left = game.clientWidth + "px";

        const bottomPipe = document.createElement("div");
        bottomPipe.classList.add("pipe", "bottom");
        bottomPipe.style.height = (game.clientHeight - bottomTop) + "px";
        bottomPipe.style.top = bottomTop + "px";
        bottomPipe.style.left = game.clientWidth + "px";

        game.appendChild(topPipe);
        game.appendChild(bottomPipe);
        pipes.push(topPipe, bottomPipe);
      }, 1800);
    }

    function endGame() {
      clearInterval(gameInterval);
      clearInterval(pipeInterval);
      isPlaying = false;
      restartBtn.style.display = "block";
      bgMusic.pause();
      bgMusic.currentTime = 0;
    }

    function flap() {
      if (!isPlaying) return;
      velocity = jump;
      firefly.classList.add("flap");
      setTimeout(() => firefly.classList.remove("flap"), 200);
    }

    window.addEventListener("touchstart", flap);
    window.addEventListener("mousedown", flap);

    startBtn.onclick = startGame;
    restartBtn.onclick = startGame;

    startBtn.style.display = "block";
  </script>
</body>
</html>
